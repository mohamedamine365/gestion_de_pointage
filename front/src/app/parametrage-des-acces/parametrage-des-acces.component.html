<div class="container">

  <p-toast position="top-right" [showTransformOptions]="'translateY(100%)'" [showTransitionOptions]="'1000ms'"
    [hideTransitionOptions]="'1000ms'" [showTransformOptions]="'translateX(100%)'" [style]="{ 
    'position': 'fixed', 
    'top': '251px', 
    'right': '20px', 
    'width': '400px', 
    'height':'200px', 
    'white-space': 'nowrap' 
  }">
  </p-toast>


  <!-- Liste des utilisateurs -->
  <div class="card card-list my-3">
    <div class="card-header  text-white" [style]="{ 'background-color': '#2c3e50' }">
      <h3 class="mb-0">Gestion des utilisateurs</h3>
    </div>
    <div class="card-body">
      <div class="mb-3 d-flex justify-content-between align-items-center">
        <!-- Ajouter un utilisateur button on the left -->
        <button class="btn btn-primary mb-2" (click)="openModal()">Ajouter un utilisateur</button>

        <!-- Search Input on the right -->
        <input type="text" class="form-control w-25" placeholder="Rechercher..." [(ngModel)]="searchTerm"
          (input)="onSearch()">
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mt-3">
          <thead>
            <tr>
              <th scope="col">Matricule</th>
              <th scope="col">Nom et prénom</th>
              <th scope="col">Privilège</th>
              <th scope="col">Etablissement</th>
              <th scope="col">Email</th>
              <th scope="col">Actif</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of currentPageUsers">
              <td>{{ user.matricule || '-' }}</td>
              <td>{{ user.nom || '-' }} {{ user.prenom || '-' }}</td>
              <td>
                <span class="badge bg-info text-dark">{{ user.privilege || '-' }}</span>
              </td>
              <td>{{ user.etablissement?.nom || '-' }}</td>

              <td>{{ user.email || '-' }}</td>
              <td>
                <span class="badge rounded-pill" [ngClass]="{'bg-success': user.actif, 'bg-danger': !user.actif}">
                  {{ user.actif ? 'Actif' : 'Inactif' }}
                </span>
              </td>
              <td>
                <div class="d-flex gap-2">
                  <button class="btn btn-warning" [routerLink]="['/user-email', user._id]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                      viewBox="0 0 16 16">
                      <path
                        d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z" />
                    </svg>
                  </button>
                  <button class="btn btn-info" [routerLink]="['/user', user._id]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewBox="0 0 576 512"
                      fill="white">
                      <path
                        d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z" />
                    </svg>
                  </button>
                  <button class="btn btn-success" (click)="openEditModal(user)">
                    <img src="assets/edit-icon.svg" alt="Edit" width="20px">
                  </button>
                  <!-- Bouton conditionnel -->
                  <ng-container *ngIf="user.actif; else inactiveUser">
                    <button class="btn btn-danger" (click)="deleteUser(user._id)">
                      <img src="assets/delete-icon.svg" alt="Delete" width="20px">
                    </button>
                  </ng-container>

                  <ng-template #inactiveUser>
                    <button class="btn" (click)="recupererUser(user._id)"
                      style="background-color: #2c3e50; color: white;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                        <path
                          d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                      </svg>
                    </button>
                  </ng-template>


                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination d-flex justify-content-center my-3">
        <button class="btn btn-outline-secondary" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
          Précédent
        </button>
        <span class="mx-2">Page {{ currentPage }} sur {{ totalPages }}</span>
        <button class="btn btn-outline-secondary" [disabled]="currentPage === totalPages"
          (click)="goToPage(currentPage + 1)">
          Suivant
        </button>
      </div>
    </div>
  </div>

  <!-- Modal personnalisé -->
  <!-- Modal personnalisé -->
  <div class="custom-modal" *ngIf="showModal">
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h5>{{ isEdit ? 'Modifier un utilisateur' : 'Ajouter un utilisateur' }}</h5>
        <button class="btn-close" (click)="closeModal()">×</button>
      </div>
      <div class="custom-modal-body">
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
          <div class="modal-body">
            <div class="row g-1">
              <!-- Matricule et Email sur même ligne -->
              <div class="col-md-6">
                <label for="matricule" class="form-label">Matricule</label>
                <input type="text" class="form-control" [class.is-invalid]="submitted && f['matricule'].errors"
                  [class.is-valid]="submitted && !f['matricule'].errors" id="matricule" formControlName="matricule">
                <div *ngIf="submitted && f['matricule'].errors" class="invalid-feedback">
                  <div *ngIf="f['matricule'].errors['required']">Le matricule est requis</div>
                  <div *ngIf="f['matricule'].errors['pattern']">Caractères alphanumériques seulement</div>
                </div>
              </div>

              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" [class.is-invalid]="submitted && f['email'].errors"
                  [class.is-valid]="submitted && !f['email'].errors" id="email" formControlName="email">
                <div *ngIf="submitted && f['email'].errors" class="invalid-feedback">
                  <div *ngIf="f['email'].errors['required']">L'email est requis</div>
                  <div *ngIf="f['email'].errors['email']">Format d'email invalide</div>
                </div>
              </div>

              <!-- Nom, Prénom et Mot de passe sur même ligne -->
              <div class="col-md-4">
                <label for="nom" class="form-label">Nom</label>
                <input type="text" class="form-control" [class.is-invalid]="submitted && f['nom'].errors"
                  [class.is-valid]="submitted && !f['nom'].errors" id="nom" formControlName="nom">
                <div *ngIf="submitted && f['nom'].errors" class="invalid-feedback">
                  <div *ngIf="f['nom'].errors['required']">Le nom est requis</div>
                  <div *ngIf="f['nom'].errors['pattern']">Lettres seulement</div>
                </div>
              </div>

              <div class="col-md-4">
                <label for="prenom" class="form-label">Prénom</label>
                <input type="text" class="form-control" [class.is-invalid]="submitted && f['prenom'].errors"
                  [class.is-valid]="submitted && !f['prenom'].errors" id="prenom" formControlName="prenom">
                <div *ngIf="submitted && f['prenom'].errors" class="invalid-feedback">
                  <div *ngIf="f['prenom'].errors['required']">Le prénom est requis</div>
                  <div *ngIf="f['prenom'].errors['pattern']">Lettres seulement</div>
                </div>
              </div>

              <div class="col-md-4">
                <label for="password" class="form-label">Mot de passe</label>
                <input type="password" class="form-control" [class.is-invalid]="submitted && f['password'].errors"
                  [class.is-valid]="submitted && !f['password'].errors" id="password" formControlName="password">
                <div *ngIf="submitted && f['password'].errors" class="invalid-feedback">
                  <div *ngIf="f['password'].errors['required']">Le mot de passe est requis</div>
                  <div *ngIf="f['password'].errors['minlength']">Minimum 8 caractères</div>
                  <div *ngIf="f['password'].errors['pattern']">
                    Doit contenir majuscule, minuscule, chiffre et caractère spécial
                  </div>
                </div>
              </div>

              <!-- Privilège et Établissement sur même ligne -->
              <div class="col-md-6">
                <label for="privilege" class="form-label">Privilège</label>
                <select class="form-select" [class.is-invalid]="submitted && f['privilege'].errors"
                  [class.is-valid]="submitted && !f['privilege'].errors" id="privilege" formControlName="privilege">
                  <option [ngValue]="null" disabled>Sélectionnez une privilege</option>
                  <option value="Admin">Admin</option>
                  <option value="Filiale">Filiale</option>
                  <option value="Groupe">Groupe</option>
                  <option value="Gestion">Gestion</option>
                </select>
                <div *ngIf="submitted && f['privilege'].errors" class="invalid-feedback">
                  Veuillez sélectionner un privilège
                </div>
              </div>

              <div class="col-md-6">
                <label for="etablissement" class="form-label">Établissement</label>
                <select class="form-select" [class.is-invalid]="submitted && f['etablissement'].errors"
                  [class.is-valid]="submitted && !f['etablissement'].errors" id="etablissement"
                  formControlName="etablissement">
                  <option [ngValue]="null" disabled>Sélectionnez un établissement</option>
                  <option *ngFor="let etablissement of etablissements" [ngValue]="etablissement">
                    {{ etablissement.nom }}
                  </option>
                </select>
                <div *ngIf="submitted && f['etablissement'].errors" class="invalid-feedback">
                  Veuillez sélectionner un établissement
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer my-4">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i> {{ isEdit ? 'Modifier' : 'Enregistrer' }}
            </button>
            <button type="button" class="btn btn-secondary mx-2" (click)="closeModal()">
              <i class="fas fa-times me-1"></i> Annuler
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>